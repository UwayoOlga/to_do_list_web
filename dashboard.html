<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Streamline</title>
  <link rel="icon" href="images/favicon.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
    }
    
    body { 
      display: flex; 
      min-height: 100vh; 
      background-color: #fff5f9; 
    }
    
    .sidebar { 
      width: 280px; 
      background-color: #ffe6f0; 
      padding: 25px 20px; 
      border-right: 2px solid #ffc0cb; 
      display: flex; 
      flex-direction: column; 
      gap: 15px; 
      position: relative;
    }
    
    .logo { 
      font-size: 28px; 
      font-weight: bold; 
      color: #c71585; 
      text-align: center;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .sidebar h4 { 
      margin-top: 15px; 
      font-size: 16px; 
      color: #a52a6d; 
      padding-left: 10px;
    }
    
    .sidebar a { 
      color: #c71585; 
      text-decoration: none; 
      font-weight: 500; 
      display: flex; 
      align-items: center;
      gap: 12px;
      padding: 10px 12px; 
      cursor: pointer; 
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .sidebar a.active, .sidebar a:hover { 
      background-color: #ffd6e7; 
      text-decoration: none;
    }
    
    .sidebar a i {
      width: 20px;
      text-align: center;
    }
    
    .content { 
      flex: 1; 
      padding: 30px 40px; 
      display: flex; 
      flex-direction: column; 
      background-color: #fff; 
    }
    
    .content-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 25px; 
    }
    
    .content-header h1 { 
      font-size: 28px; 
      color: #c71585; 
      font-weight: 600;
    }
    
    .add-task { 
      background-color: #ff69b4; 
      color: white; 
      padding: 10px 20px; 
      border: none; 
      border-radius: 8px; 
      font-size: 14px; 
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.3s;
    }
    
    .add-task:hover { 
      background-color: #e0559c; 
    }
    
    .empty-state { 
      text-align: center; 
      margin-top: 80px; 
      color: #888;
    }
    
    .empty-state img { 
      width: 180px; 
      opacity: 0.7; 
    }
    
    .empty-state p { 
      margin-top: 16px; 
      font-size: 16px; 
      color: #c71585;
    }
    
    .task-card { 
      border: 1px solid #ffd6e7; 
      padding: 18px; 
      border-radius: 12px; 
      background-color: #fff9fb; 
      display: flex; 
      align-items: flex-start; 
      justify-content: space-between;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 12px;
    }
    
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 105, 180, 0.1);
    }
    
    .task-info { 
      flex: 1; 
    }
    
    .task-info h3 { 
      color: #c71585; 
      margin-bottom: 8px; 
      font-size: 18px;
      font-weight: 600;
    }
    
    .task-info p { 
      margin: 5px 0; 
      color: #666;
      font-size: 14px;
    }
    
    .task-meta {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .task-tag {
      background-color: #ffd6e7;
      color: #c71585;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .task-priority {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .priority-high {
      background-color: #ffebee;
      color: #f44336;
    }
    
    .priority-medium {
      background-color: #fff8e1;
      color: #ff9800;
    }
    
    .priority-low {
      background-color: #e8f5e9;
      color: #4caf50;
    }
    
    .task-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 15px;
    }
    
    .task-checkbox {
      width: 20px;
      height: 20px;
      accent-color: #ff69b4;
      cursor: pointer;
    }
    
    .task-buttons {
      display: flex;
      gap: 10px;
    }
    
    .task-button {
      background: none;
      border: none;
      cursor: pointer;
      color: #c71585;
      font-size: 16px;
      transition: color 0.2s;
    }
    
    .task-button:hover {
      color: #e0559c;
    }
    
    .modal { 
      display: none; 
      position: fixed; 
      z-index: 999; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0, 0, 0, 0.4); 
    }
    
    .modal-content { 
      background-color: #fff; 
      margin: 10% auto; 
      padding: 25px; 
      border-radius: 12px; 
      width: 90%; 
      max-width: 500px; 
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); 
    }
    
    .modal-content h2 { 
      color: #c71585; 
      margin-bottom: 20px; 
      font-size: 24px;
    }
    
    .modal-content h3 { 
      color: #c71585; 
      margin-bottom: 15px; 
      font-size: 20px;
    }
    
    .modal-content label { 
      display: block; 
      margin-top: 15px; 
      color: #666;
      font-weight: 500;
      font-size: 14px;
    }
    
    .modal-content input, 
    .modal-content textarea, 
    .modal-content select { 
      width: 100%; 
      padding: 10px; 
      margin-top: 8px; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      font-size: 14px;
    }
    
    .modal-content textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal-content .form-row {
      display: flex;
      gap: 15px;
    }
    
    .modal-content .form-group {
      flex: 1;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-button {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .modal-button.primary {
      background-color: #ff69b4; 
      color: white; 
      border: none;
    }
    
    .modal-button.primary:hover { 
      background-color: #e0559c; 
    }
    
    .modal-button.secondary {
      background-color: #f0f0f0; 
      color: #666; 
      border: none;
    }
    
    .modal-button.secondary:hover { 
      background-color: #e0e0e0; 
    }
    
    .close { 
      float: right; 
      font-size: 24px; 
      font-weight: bold; 
      color: #999; 
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .close:hover {
      color: #666;
    }
    
    #success-message {
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #d4edda;
      color: #155724;
      padding: 12px 24px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      font-size: 14px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease-in-out;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #success-message.show {
      opacity: 1;
    }
    
    .search-bar {
      margin-bottom: 25px;
      position: relative;
    }
    
    .search-bar input {
      width: 100%;
      padding: 12px 15px 12px 40px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background-color: #fff9fb;
    }
    
    .search-bar i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #c71585;
    }
    
    .filter-sort {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .filter-button, .sort-button {
      background-color: #fff9fb;
      border: 1px solid #ffd6e7;
      color: #c71585;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s;
    }
    
    .filter-button:hover, .sort-button:hover {
      background-color: #ffd6e7;
    }
    
    .filter-button.active, .sort-button.active {
      background-color: #ff69b4;
      color: white;
      border-color: #ff69b4;
    }
    
    @media (max-width: 768px) {
      body { 
        flex-direction: column; 
      }
      
      .sidebar { 
        width: 100%; 
        border-right: none; 
        border-bottom: 2px solid #ffc0cb; 
        flex-direction: row; 
        flex-wrap: wrap; 
        justify-content: flex-start; 
        padding: 15px;
      }
      
      .logo {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .sidebar h4 {
        width: 100%;
        margin-top: 5px;
      }
      
      .content { 
        padding: 20px; 
      }
      
      .content-header { 
        flex-direction: column; 
        align-items: flex-start; 
        gap: 15px; 
      }
      
      .filter-sort {
        flex-wrap: wrap;
      }
      
      .profile-section {
        position: absolute;
        right: 15px;
        top: 15px;
        margin: 0;
      }
      
      .profile-icon {
        margin: 0;
        width: 40px;
        height: 40px;
      }
    }
    
    .profile-section {
      position: relative;
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid #ffc0cb;
    }
    
    .profile-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      object-fit: cover;
      border: 3px solid #c71585;
      background-color: #ff91c8; 
      margin: 0 auto;
      display: block;
    }
    
    .profile-name {
      text-align: center;
      margin-top: 8px;
      font-weight: 500;
      color: #c71585;
    }
    
    .profile-menu {
      display: none;
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background-color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 10px 0;
      width: 180px;
      z-index: 1000;
    }
    
    .profile-menu button {
      display: block;
      width: 100%;
      background: none;
      border: none;
      padding: 10px 15px;
      text-align: left;
      cursor: pointer;
      color: #666;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    
    .profile-menu button:hover {
      background-color: #ffe6f0;
      color: #c71585;
    }
    
    .profile-menu button i {
      width: 20px;
      margin-right: 8px;
    }
    
    /* Task completion animation */
    @keyframes taskComplete {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .completed-task {
      opacity: 0.7;
      background-color: #f9f9f9;
      border-color: #e0e0e0;
    }
    
    .completed-task h3, .completed-task p {
      color: #999 !important;
      text-decoration: line-through;
    }
    
    /* Priority indicator dots */
    .priority-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .dot-high { background-color: #f44336; }
    .dot-medium { background-color: #ff9800; }
    .dot-low { background-color: #4caf50; }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,105,180,0.3);
      border-radius: 50%;
      border-top-color: #ff69b4;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Project color indicators */
    .project-color {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    /* Report button */
    .report-button {
      background-color: #4caf50;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.3s;
    }
    
    .report-button:hover {
      background-color: #3d8b40;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <div class="logo">
      <i class="fas fa-stream"></i> Streamline
    </div>
    <a class="active" id="today-link"><i class="fas fa-calendar-day"></i> Today</a>
    <a id="upcoming-link"><i class="fas fa-calendar-week"></i> Upcoming</a>
    <a id="completed-link"><i class="fas fa-check-circle"></i> Completed</a>
    <a id="all-link"><i class="fas fa-tasks"></i> All Tasks</a>
    
    <h4><i class="fas fa-folder"></i> My Projects</h4>
    <div id="projects-list">
      <!-- Projects will be dynamically added here -->
    </div>
    <a id="add-project-link"><i class="fas fa-plus"></i> Add Project</a>
    
    <div class="profile-section">
      <img src="https://ui-avatars.com/api/?name=User&background=ff91c8&color=fff" alt="Profile" class="profile-icon" id="profileIcon" />
      <div class="profile-name" id="profileName">User</div>
      <div class="profile-menu" id="profileMenu">
        <button onclick="openProfileModal()"><i class="fas fa-user-edit"></i> Edit Profile</button>
        <button onclick="openSettingsModal()"><i class="fas fa-cog"></i> Settings</button>
        <button onclick="generateReport()"><i class="fas fa-file-pdf"></i> Generate Report</button>
        <button onclick="confirmLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="content-header">
      <h1 id="page-title">Today</h1>
      <div style="display: flex; gap: 10px;">
        <button class="report-button" onclick="generateReport()">
          <i class="fas fa-file-pdf"></i> Generate Report
        </button>
        <button class="add-task" onclick="openTaskForm()"><i class="fas fa-plus"></i> Add Task</button>
      </div>
    </div>
    
    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="Search tasks..." />
    </div>
    
    <div class="filter-sort">
      <div class="filter-buttons">
        <button class="filter-button active" data-filter="all">All</button>
        <button class="filter-button" data-filter="high"><span class="priority-dot dot-high"></span>High</button>
        <button class="filter-button" data-filter="medium"><span class="priority-dot dot-medium"></span>Medium</button>
        <button class="filter-button" data-filter="low"><span class="priority-dot dot-low"></span>Low</button>
      </div>
      <div class="sort-buttons">
        <button class="sort-button active" data-sort="dueDate"><i class="fas fa-calendar-alt"></i> Due Date</button>
        <button class="sort-button" data-sort="priority"><i class="fas fa-flag"></i> Priority</button>
      </div>
    </div>
    
    <div id="success-message">
      <i class="fas fa-check-circle"></i>
      <span id="success-text">Task added successfully!</span>
    </div>
    
    <div class="empty-state" id="emptyState">
      <img src="https://cdn-icons-png.flaticon.com/512/4076/4076478.png" alt="No tasks">
      <p>What do you need to get done today?<br>Click the "+ Add Task" button to get started.</p>
    </div>
    
    <div id="task-container"></div>
  </div>

  <!-- Task Form Modal -->
  <div id="taskFormModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeTaskForm()">&times;</span>
      <h2 id="task-form-title">Add New Task</h2>
      <form id="taskForm">
        <div class="form-row">
          <div class="form-group" style="flex: 2;">
            <label for="task-title">Title*</label>
            <input type="text" id="task-title" required />
          </div>
          <div class="form-group">
            <label for="task-priority">Priority</label>
            <select id="task-priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
        
        <label for="task-desc">Description</label>
        <textarea id="task-desc" rows="3"></textarea>
        
        <div class="form-row">
          <div class="form-group">
            <label for="task-date">Due Date*</label>
            <input type="date" id="task-date" required />
          </div>
          <div class="form-group">
            <label for="task-time">Time (optional)</label>
            <input type="time" id="task-time" />
          </div>
        </div>
        
        <div class="form-group">
          <label for="task-tags">Tags (comma separated)</label>
          <input type="text" id="task-tags" placeholder="work, urgent, project" />
        </div>
        
        <div class="form-group">
          <label for="task-project">Project</label>
          <select id="task-project">
            <option value="">None</option>
            <!-- Projects will be dynamically added here -->
          </select>
        </div>
        
        <div class="modal-buttons">
          <button type="button" class="modal-button secondary" onclick="closeTaskForm()">Cancel</button>
          <button type="submit" class="modal-button primary" id="task-submit-btn">
            <span id="submit-btn-text">Save Task</span>
            <span id="submit-btn-spinner" class="spinner" style="display: none;"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
  
<!-- Edit Profile Modal -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeProfileModal()">&times;</span>
    <h2>Edit Profile</h2>
    <form id="profileForm">
      <div class="form-group">
        <label for="profile-name">Display Name</label>
        <input type="text" id="profile-name" required />
      </div>
      
      <div class="form-group">
        <label for="profile-email">Email</label>
        <input type="email" id="profile-email" required />
      </div>
      
      <div class="form-group">
        <label for="profile-password">New Password (leave blank to keep current)</label>
        <input type="password" id="profile-password" placeholder="Enter new password" />
      </div>
      
      <div class="form-group">
        <label for="profile-photo">Photo URL</label>
        <input type="text" id="profile-photo" placeholder="Enter image URL" />
      </div>
      
      <div class="modal-buttons">
        <button type="button" class="modal-button secondary" onclick="closeProfileModal()">Cancel</button>
        <button type="submit" class="modal-button primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>
  
  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSettingsModal()">&times;</span>
      <h2>Settings</h2>
      
      <div class="form-group">
        <label>Theme</label>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <div class="theme-option" data-theme="pink" style="background: #ffe6f0; border: 2px solid #ff69b4; width: 40px; height: 40px; border-radius: 8px; cursor: pointer;"></div>
          <div class="theme-option" data-theme="blue" style="background: #e6f0ff; border: 2px solid #6991ff; width: 40px; height: 40px; border-radius: 8px; cursor: pointer;"></div>
          <div class="theme-option" data-theme="green" style="background: #e6ffe6; border: 2px solid #69ff69; width: 40px; height: 40px; border-radius: 8px; cursor: pointer;"></div>
          <div class="theme-option" data-theme="dark" style="background: #2d2d2d; border: 2px solid #555; width: 40px; height: 40px; border-radius: 8px; cursor: pointer;"></div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="notifications">Enable Notifications</label>
        <div style="margin-top: 8px;">
          <input type="checkbox" id="notifications" style="width: auto;" />
        </div>
      </div>
      
      <div class="modal-buttons">
        <button type="button" class="modal-button secondary" onclick="closeSettingsModal()">Cancel</button>
        <button type="button" class="modal-button primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>
  
  <!-- Add Project Modal -->
  <div id="projectModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeProjectModal()">&times;</span>
      <h2>Add New Project</h2>
      <form id="projectForm">
        <div class="form-group">
          <label for="project-name">Project Name*</label>
          <input type="text" id="project-name" required />
        </div>
        
        <div class="form-group">
          <label for="project-color">Color</label>
          <select id="project-color">
            <option value="#ff69b4">Pink</option>
            <option value="#6991ff">Blue</option>
            <option value="#69ff69">Green</option>
            <option value="#ffcc00">Yellow</option>
            <option value="#ff6666">Red</option>
            <option value="#9966ff">Purple</option>
          </select>
        </div>
        
        <div class="modal-buttons">
          <button type="button" class="modal-button secondary" onclick="closeProjectModal()">Cancel</button>
          <button type="submit" class="modal-button primary">Create Project</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged,
      signOut,
      updateProfile,
      updateEmail,
      updatePassword,
      EmailAuthProvider,
      reauthenticateWithCredential
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      updateDoc,
      doc,
      deleteDoc,
      query,
      where,
      orderBy,
      serverTimestamp,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase configuration and initialization
    const firebaseConfig = {
      apiKey: "AIzaSyA_iYY1cpnwjW4idgEmpVScj3SecxN2Qss",
      authDomain: "todolistwebapp-eb8cb.firebaseapp.com",
      projectId: "todolistwebapp-eb8cb",
      storageBucket: "todolistwebapp-eb8cb.appspot.com",
      messagingSenderId: "869793857380",
      appId: "1:869793857380:web:79b4a200e73bae6c088471",
      measurementId: "G-7LX95XNM4M"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // References to collections
    const tasksRef = collection(db, "tasks");
    const projectsRef = collection(db, "projects");
    const usersRef = collection(db, "users");
    
    // DOM elements
    const taskContainer = document.getElementById('task-container');
    const emptyState = document.getElementById('emptyState');
    const pageTitle = document.getElementById('page-title');
    const searchInput = document.getElementById('searchInput');
    const successMessage = document.getElementById('success-message');
    const successText = document.getElementById('success-text');
    const profileIcon = document.getElementById('profileIcon');
    const profileName = document.getElementById('profileName');
    const projectsList = document.getElementById('projects-list');
    
    // State variables
    let allTasks = [];
    let allProjects = [];
    let currentView = 'today';
    let currentFilter = 'all';
    let currentSort = 'dueDate';
    let currentSearch = '';
    let editingTaskId = null;
    let editingProjectId = null;
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Set up event listeners
      setupEventListeners();
      
      // Set today's date as default in task form
      document.getElementById('task-date').valueAsDate = new Date();
      
      // Check auth state
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in
          loadUserProfile(user);
          
          // Load data
          loadTasks();
          loadProjects();
        } else {
          // User is signed out
          window.location.href = 'login.html';
        }
      });
    });
    
    // Load user profile from Firestore
    async function loadUserProfile(user) {
      try {
        const userDocRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
          // User profile exists in Firestore
          const userData = userDoc.data();
          updateProfileUI(user, userData);
        } else {
          // Create new user profile in Firestore
          const newUserProfile = {
            displayName: user.displayName || 'User',
            email: user.email || '',
            photoURL: user.photoURL || '',
            createdAt: serverTimestamp(),
            lastUpdated: serverTimestamp()
          };
          
          await setDoc(userDocRef, newUserProfile);
          updateProfileUI(user, newUserProfile);
        }
      } catch (error) {
        console.error("Error loading user profile:", error);
        // Fallback to auth profile if Firestore fails
        updateProfileUI(user);
      }
    }
    
    // Update profile UI
    function updateProfileUI(user, userData = null) {
      const displayName = userData?.displayName || user.displayName || 'User';
      const photoURL = userData?.photoURL || user.photoURL;
      
      profileName.textContent = displayName;
      profileIcon.src = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=ff91c8&color=fff`;
      
      // Populate profile form
      document.getElementById('profile-name').value = displayName;
      document.getElementById('profile-email').value = user.email || '';
      document.getElementById('profile-photo').value = photoURL || '';
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Navigation links
      document.getElementById('today-link').addEventListener('click', () => setView('today', 'Today'));
      document.getElementById('upcoming-link').addEventListener('click', () => setView('upcoming', 'Upcoming'));
      document.getElementById('completed-link').addEventListener('click', () => setView('completed', 'Completed'));
      document.getElementById('all-link').addEventListener('click', () => setView('all', 'All Tasks'));
      document.getElementById('add-project-link').addEventListener('click', openProjectModal);
      
      // Filter and sort buttons
      document.querySelectorAll('.filter-button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderTasks();
        });
      });
      
      document.querySelectorAll('.sort-button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.sort-button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSort = btn.dataset.sort;
          renderTasks();
        });
      });
      
      // Search input
      searchInput.addEventListener('input', (e) => {
        currentSearch = e.target.value.toLowerCase();
        renderTasks();
      });
      
      // Task form submission
      document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
      
      // Profile form submission
      document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
      
      // Project form submission
      document.getElementById('projectForm').addEventListener('submit', handleProjectSubmit);
      
      // Click outside modals to close
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            if (modal.id === 'taskFormModal') closeTaskForm();
            if (modal.id === 'profileModal') closeProfileModal();
            if (modal.id === 'settingsModal') closeSettingsModal();
            if (modal.id === 'projectModal') closeProjectModal();
          }
        });
      });
    }
    
    // Load tasks from Firestore
    function loadTasks() {
      const q = query(tasksRef, orderBy('created', 'desc'));
      
      onSnapshot(q, (snapshot) => {
        allTasks = snapshot.docs.map(doc => ({ 
          id: doc.id, 
          ...doc.data(),
          // Convert Firestore Timestamp to Date if needed
          date: doc.data().date?.toDate ? formatDate(doc.data().date.toDate()) : doc.data().date,
          created: doc.data().created?.toDate ? doc.data().created.toDate() : doc.data().created
        }));
        
        renderTasks();
      });
    }
    
    // Load projects from Firestore
    function loadProjects() {
      onSnapshot(projectsRef, (snapshot) => {
        allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderProjects();
        updateProjectDropdown();
      });
    }
    
    // Render projects in sidebar
    function renderProjects() {
      projectsList.innerHTML = '';
      
      allProjects.forEach(project => {
        const projectLink = document.createElement('a');
        projectLink.innerHTML = `
          <span class="project-color" style="background-color: ${project.color}"></span>
          ${project.name}
        `;
        projectLink.addEventListener('click', () => filterByProject(project.id));
        projectsList.appendChild(projectLink);
      });
    }
    
    // Filter tasks by project
    function filterByProject(projectId) {
      currentView = 'project';
      currentFilter = projectId;
      pageTitle.textContent = allProjects.find(p => p.id === projectId)?.name || 'Project';
      renderTasks();
    }
    
    // Update project dropdown in task form
    function updateProjectDropdown() {
      const projectSelect = document.getElementById('task-project');
      // Clear existing options except the first "None" option
      while (projectSelect.options.length > 1) {
        projectSelect.remove(1);
      }
      
      // Add projects from Firestore
      allProjects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        projectSelect.appendChild(option);
      });
    }
    
    // Set current view (today, upcoming, completed, all)
    function setView(view, title) {
      currentView = view;
      pageTitle.textContent = title;
      
      // Update active nav link
      document.querySelectorAll('.sidebar a').forEach(link => link.classList.remove('active'));
      document.getElementById(`${view}-link`).classList.add('active');
      
      renderTasks();
    }
    
    // Render tasks based on current view, filter, sort, and search
    function renderTasks() {
      taskContainer.innerHTML = '';
      
      // Filter tasks based on current view
      let filteredTasks = filterTasksByView(allTasks, currentView);
      
      // Apply additional filters
      filteredTasks = applyAdditionalFilters(filteredTasks);
      
      // Sort tasks
      filteredTasks = sortTasks(filteredTasks, currentSort);
      
      // Show empty state if no tasks
      if (filteredTasks.length === 0) {
        emptyState.style.display = 'block';
        
        // Customize empty state message based on view
        let message = 'No tasks found.';
        if (currentSearch) {
          message = `No tasks match "${currentSearch}".`;
        } else if (currentView === 'today') {
          message = 'What do you need to get done today?';
        } else if (currentView === 'upcoming') {
          message = 'No upcoming tasks. Enjoy your free time!';
        } else if (currentView === 'completed') {
          message = 'No completed tasks yet. Get to work!';
        } else if (currentView === 'project') {
          message = 'No tasks in this project yet.';
        }
        
        emptyState.querySelector('p').textContent = message;
      } else {
        emptyState.style.display = 'none';
      }
      
      // Create task cards
      filteredTasks.forEach(task => {
        const taskCard = createTaskCard(task);
        taskContainer.appendChild(taskCard);
      });
    }
    
    // Filter tasks by current view
    function filterTasksByView(tasks, view) {
      const today = new Date().toISOString().split('T')[0];
      const now = new Date();
      
      switch(view) {
        case 'today':
          return tasks.filter(task => task.date === today && task.status !== 'completed');
        case 'upcoming':
          return tasks.filter(task => {
            const taskDate = new Date(task.date);
            return taskDate > now && task.status !== 'completed';
          });
        case 'completed':
          return tasks.filter(task => task.status === 'completed');
        case 'project':
          return tasks.filter(task => task.project === currentFilter);
        default:
          return tasks;
      }
    }
    
    // Apply additional filters (priority, search)
    function applyAdditionalFilters(tasks) {
      let filtered = [...tasks];
      
      // Priority filter
      if (currentFilter !== 'all' && currentView !== 'project') {
        filtered = filtered.filter(task => task.priority === currentFilter);
      }
      
      // Search filter
      if (currentSearch) {
        filtered = filtered.filter(task => 
          task.title.toLowerCase().includes(currentSearch) || 
          (task.desc && task.desc.toLowerCase().includes(currentSearch)) ||
          (task.tags && task.tags.some(tag => tag.toLowerCase().includes(currentSearch)))
        );
      }
      
      return filtered;
    }
    
    // Sort tasks
    function sortTasks(tasks, sortBy) {
      const sorted = [...tasks];
      
      switch(sortBy) {
        case 'dueDate':
          return sorted.sort((a, b) => new Date(a.date) - new Date(b.date));
        case 'priority':
          const priorityOrder = { high: 1, medium: 2, low: 3 };
          return sorted.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
        default:
          return sorted;
      }
    }
    
    // Create a task card element
    function createTaskCard(task) {
      const card = document.createElement('div');
      card.className = `task-card ${task.status === 'completed' ? 'completed-task' : ''}`;
      card.dataset.taskId = task.id;
      
      // Task info section
      const info = document.createElement('div');
      info.className = 'task-info';
      
      const title = document.createElement('h3');
      title.textContent = task.title;
      
      const desc = document.createElement('p');
      desc.textContent = task.desc || '';
      
      const meta = document.createElement('div');
      meta.className = 'task-meta';
      
      const dueDate = document.createElement('p');
      dueDate.innerHTML = `<i class="far fa-calendar-alt" style="color: #c71585; margin-right: 5px;"></i>Due: ${formatDisplayDate(task.date)}`;
      
      meta.appendChild(dueDate);
      
      // Priority tag
      if (task.priority) {
        const priority = document.createElement('span');
        priority.className = `task-priority priority-${task.priority}`;
        priority.innerHTML = `<i class="fas fa-flag" style="margin-right: 3px;"></i>${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}`;
        meta.appendChild(priority);
      }
      
      // Project tag
      if (task.project) {
        const project = document.createElement('span');
        project.className = 'task-tag';
        const projectData = allProjects.find(p => p.id === task.project);
        if (projectData) {
          project.innerHTML = `<span class="project-color" style="background-color: ${projectData.color}"></span>${projectData.name}`;
          meta.appendChild(project);
        }
      }
      
      // Tags
      if (task.tags && task.tags.length > 0) {
        task.tags.forEach(tag => {
          const tagElement = document.createElement('span');
          tagElement.className = 'task-tag';
          tagElement.textContent = tag;
          meta.appendChild(tagElement);
        });
      }
      
      info.appendChild(title);
      info.appendChild(desc);
      info.appendChild(meta);
      
      // Task actions section
      const actions = document.createElement('div');
      actions.className = 'task-actions';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'task-checkbox';
      checkbox.checked = task.status === 'completed';
      checkbox.addEventListener('change', () => toggleTaskStatus(task.id, checkbox.checked));
      
      const buttons = document.createElement('div');
      buttons.className = 'task-buttons';
      
      const editBtn = document.createElement('button');
      editBtn.className = 'task-button';
      editBtn.innerHTML = '<i class="far fa-edit"></i>';
      editBtn.title = 'Edit Task';
      editBtn.addEventListener('click', () => editTask(task.id));
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'task-button';
      deleteBtn.innerHTML = '<i class="far fa-trash-alt"></i>';
      deleteBtn.title = 'Delete Task';
      deleteBtn.addEventListener('click', () => deleteTask(task.id));
      
      buttons.appendChild(editBtn);
      buttons.appendChild(deleteBtn);
      
      actions.appendChild(checkbox);
      actions.appendChild(buttons);
      
      card.appendChild(info);
      card.appendChild(actions);
      
      return card;
    }
    
    // Handle task form submission
    async function handleTaskSubmit(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('task-submit-btn');
      const submitText = document.getElementById('submit-btn-text');
      const submitSpinner = document.getElementById('submit-btn-spinner');
      
      // Show loading state
      submitText.textContent = 'Saving...';
      submitSpinner.style.display = 'inline-block';
      submitBtn.disabled = true;
      
      try {
        const taskData = {
          title: document.getElementById('task-title').value,
          desc: document.getElementById('task-desc').value,
          date: document.getElementById('task-date').value,
          time: document.getElementById('task-time').value || null,
          priority: document.getElementById('task-priority').value,
          project: document.getElementById('task-project').value || null,
          tags: document.getElementById('task-tags').value 
            ? document.getElementById('task-tags').value.split(',').map(tag => tag.trim())
            : [],
          status: 'pending',
          created: serverTimestamp(),
          userId: auth.currentUser.uid
        };
        
        if (editingTaskId) {
          // Update existing task
          await updateDoc(doc(db, 'tasks', editingTaskId), taskData);
          showSuccess('Task updated successfully!');
        } else {
          // Add new task
          await addDoc(tasksRef, taskData);
          showSuccess('Task added successfully!');
        }
        
        closeTaskForm();
        e.target.reset();
      } catch (error) {
        alert('Error saving task: ' + error.message);
      } finally {
        // Reset button state
        submitText.textContent = editingTaskId ? 'Update Task' : 'Save Task';
        submitSpinner.style.display = 'none';
        submitBtn.disabled = false;
        editingTaskId = null;
      }
    }
    
    // Toggle task status (complete/incomplete)
    async function toggleTaskStatus(taskId, isCompleted) {
      try {
        await updateDoc(doc(db, 'tasks', taskId), {
          status: isCompleted ? 'completed' : 'pending'
        });
        
        const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
        if (taskCard) {
          taskCard.classList.toggle('completed-task', isCompleted);
          
          // Add animation for completed tasks
          if (isCompleted) {
            taskCard.style.animation = 'taskComplete 0.5s ease';
            setTimeout(() => {
              taskCard.style.animation = '';
            }, 500);
          }
        }
      } catch (error) {
        alert('Error updating task status: ' + error.message);
      }
    }
    
    // Edit task
    function editTask(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;
      
      editingTaskId = taskId;
      
      // Fill the form with task data
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-desc').value = task.desc || '';
      document.getElementById('task-date').value = task.date;
      document.getElementById('task-time').value = task.time || '';
      document.getElementById('task-priority').value = task.priority || 'medium';
      document.getElementById('task-project').value = task.project || '';
      document.getElementById('task-tags').value = task.tags ? task.tags.join(', ') : '';
      
      // Update form title
      document.getElementById('task-form-title').textContent = 'Edit Task';
      document.getElementById('submit-btn-text').textContent = 'Update Task';
      
      openTaskForm();
    }
    
    // Delete task
    async function deleteTask(taskId) {
      const confirmDelete = confirm('Are you sure you want to delete this task?');
      if (!confirmDelete) return;
      
      try {
        await deleteDoc(doc(db, 'tasks', taskId));
        showSuccess('Task deleted successfully!');
      } catch (error) {
        alert('Error deleting task: ' + error.message);
      }
    }
    
    // Handle profile update
    async function handleProfileUpdate(e) {
      e.preventDefault();
      
      const user = auth.currentUser;
      if (!user) return;
      
      try {
        const displayName = document.getElementById('profile-name').value;
        const email = document.getElementById('profile-email').value;
        const password = document.getElementById('profile-password').value;
        const photoURL = document.getElementById('profile-photo').value;
        
        // Update profile in Firestore
        const userDocRef = doc(db, "users", user.uid);
        await updateDoc(userDocRef, {
          displayName,
          email,
          photoURL: photoURL || null,
          lastUpdated: serverTimestamp()
        });
        
        // Update auth profile
        await updateProfile(user, {
          displayName,
          photoURL: photoURL || null
        });
        
        // Update email if changed
        if (email !== user.email) {
          await updateEmail(user, email);
        }
        
        // Update password if provided
        if (password) {
          await updatePassword(user, password);
        }
        
        // Update UI
        updateProfileUI(user);
        
        showSuccess('Profile updated successfully!');
        closeProfileModal();
      } catch (error) {
        if (error.code === 'auth/requires-recent-login') {
          alert('Please reauthenticate to update sensitive information.');
          // Here you could implement a reauthentication flow
        } else {
          alert('Error updating profile: ' + error.message);
        }
      }
    }
    
    // Handle project creation
    async function handleProjectSubmit(e) {
      e.preventDefault();
      
      try {
        const projectData = {
          name: document.getElementById('project-name').value,
          color: document.getElementById('project-color').value,
          createdAt: serverTimestamp(),
          userId: auth.currentUser.uid
        };
        
        await addDoc(projectsRef, projectData);
        
        showSuccess('Project created successfully!');
        closeProjectModal();
        e.target.reset();
      } catch (error) {
        alert('Error creating project: ' + error.message);
      }
    }
    
    // Save settings
    function saveSettings() {
      const notificationsEnabled = document.getElementById('notifications').checked;
      localStorage.setItem('notificationsEnabled', notificationsEnabled);
      
      const theme = document.querySelector('.theme-option.active')?.dataset.theme || 'pink';
      localStorage.setItem('theme', theme);
      
      showSuccess('Settings saved successfully!');
      closeSettingsModal();
    }
    
    // Generate PDF report
    async function generateReport() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Report title
      doc.setFontSize(20);
      doc.setTextColor(199, 21, 133);
      doc.text('Task Report', 105, 20, { align: 'center' });
      
      // User info
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      const user = auth.currentUser;
      doc.text(`Generated by: ${user.displayName || 'User'}`, 14, 30);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 37);
      
      // Filter tasks for report
      let reportTasks = [...allTasks];
      if (currentView === 'today') {
        const today = new Date().toISOString().split('T')[0];
        reportTasks = reportTasks.filter(task => task.date === today);
      } else if (currentView === 'upcoming') {
        const now = new Date();
        reportTasks = reportTasks.filter(task => new Date(task.date) > now && task.status !== 'completed');
      } else if (currentView === 'completed') {
        reportTasks = reportTasks.filter(task => task.status === 'completed');
      } else if (currentView === 'project') {
        reportTasks = reportTasks.filter(task => task.project === currentFilter);
      }
      
      // Prepare data for table
      const tableData = reportTasks.map(task => {
        const project = task.project ? allProjects.find(p => p.id === task.project)?.name : 'None';
        return [
          task.title,
          task.desc || '',
          formatDisplayDate(task.date),
          task.priority ? task.priority.charAt(0).toUpperCase() + task.priority.slice(1) : '',
          project,
          task.status === 'completed' ? 'Yes' : 'No'
        ];
      });
      
      // Add table to PDF
      doc.autoTable({
        head: [['Title', 'Description', 'Due Date', 'Priority', 'Project', 'Completed']],
        body: tableData,
        startY: 45,
        theme: 'grid',
        headStyles: {
          fillColor: [199, 21, 133],
          textColor: 255
        },
        alternateRowStyles: {
          fillColor: [255, 230, 240]
        }
      });
      
      // Save the PDF
      doc.save(`TaskReport_${new Date().toISOString().split('T')[0]}.pdf`);
      showSuccess('Report generated successfully!');
    }
    
    // Show success message
    function showSuccess(message) {
      successText.textContent = message;
      successMessage.classList.add('show');
      
      setTimeout(() => {
        successMessage.classList.remove('show');
      }, 3000);
    }
    
    // Format date for display
    function formatDisplayDate(dateString) {
      if (!dateString) return 'No date';
      
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric' 
      });
    }
    
    // Format date for input field
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }
    
    // Modal functions
    function openTaskForm() {
      document.getElementById('taskFormModal').style.display = 'block';
      document.getElementById('task-title').focus();
    }
    
    function closeTaskForm() {
      document.getElementById('taskFormModal').style.display = 'none';
      document.getElementById('taskForm').reset();
      document.getElementById('task-form-title').textContent = 'Add New Task';
      document.getElementById('submit-btn-text').textContent = 'Save Task';
      editingTaskId = null;
    }
    
    function openProfileModal() {
      document.getElementById('profileModal').style.display = 'block';
      toggleProfileMenu();
    }
    
    function closeProfileModal() {
      document.getElementById('profileModal').style.display = 'none';
    }
    
    function openSettingsModal() {
      // Load saved settings
      document.getElementById('notifications').checked = localStorage.getItem('notificationsEnabled') === 'true';
      
      const savedTheme = localStorage.getItem('theme') || 'pink';
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.toggle('active', option.dataset.theme === savedTheme);
      });
      
      document.getElementById('settingsModal').style.display = 'block';
      toggleProfileMenu();
    }
    
    function closeSettingsModal() {
      document.getElementById('settingsModal').style.display = 'none';
    }
    
    function openProjectModal() {
      document.getElementById('projectModal').style.display = 'block';
    }
    
    function closeProjectModal() {
      document.getElementById('projectModal').style.display = 'none';
      document.getElementById('projectForm').reset();
    }
    
    // Profile menu toggle
    function toggleProfileMenu() {
      const menu = document.getElementById('profileMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    
    // Close profile menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.profile-section')) {
        document.getElementById('profileMenu').style.display = 'none';
      }
    });
    
    // Confirm logout
    function confirmLogout() {
      if (confirm('Are you sure you want to logout?')) {
        logout();
      }
    }
    
    // Logout function
    function logout() {
      signOut(auth).then(() => {
        window.location.href = 'login.html';
      }).catch((error) => {
        alert('Error logging out: ' + error.message);
      });
    }
    
    // Make functions available globally
    window.openTaskForm = openTaskForm;
    window.closeTaskForm = closeTaskForm;
    window.openProfileModal = openProfileModal;
    window.closeProfileModal = closeProfileModal;
    window.openSettingsModal = openSettingsModal;
    window.closeSettingsModal = closeSettingsModal;
    window.openProjectModal = openProjectModal;
    window.closeProjectModal = closeProjectModal;
    window.toggleProfileMenu = toggleProfileMenu;
    window.logout = logout;
    window.confirmLogout = confirmLogout;
    window.saveSettings = saveSettings;
    window.generateReport = generateReport;
    
    // Theme selection
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
        option.classList.add('active');
      });
    });
    
  </script>
</body>
</html>